<!DOCTYPE html>
<html lang="en">

<head>
    <title>AI Image</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="matter.css">
    <script src="matter.js"></script>
</head>

<body onload="load()">
    <header id="header_id">
        <div class="matter-menubar">
            <ul>
                <li onclick="show_home_panel()" style="cursor:pointer;">Home</li>
                <li>Project
                    <ul>
                        <li onclick="projectOpen()" title="Open project (from a JSON file)">Open</li>
                        <li onclick="projectSave()" title="Save project (as a JSON file)">Save</li>
                        <li class="submenu-divider"></li>
                        <li onclick="projectAddFiles()" title="Add files">Add files</li>
                        <li onclick="projectDeleteFile()" title="Remove selected file">Remove file</li>
                    </ul>
                </li>
                <li>Preview
                    <ul>
                        <li onclick="" title="Show clean image">Clean</li>
                        <li onclick="" title="Show color image">Color</li>
                        <li onclick="" title="Show zoom image">Zoom</li>
                        <li onclick="" title="Show atch image">Patch</li>
                    </ul>
                </li>
                <li>Help
                    <ul>
                        <li onclick="" title="Show a guide to getting started">Getting Started</li>
                        <li class="submenu-divider"></li>
                        <li onclick="" title="Show more details about this application">About</li>
                    </ul>
                </li>
            </ul>
        </div>
    </header>
    <main id="main_id">
        <leftside id="left_side_id">
            <label class="matter-textfield-filled" style="width: 100%; height: 64px;">
                <input placeholder="" onchange="projectChangeName(this)" id="project_name" />
                <span>Project</span>
            </label>
            <!--  add style to remove flex layout -->
            <div id="file_name_list_id" class="matter-file-name-list" style="display: block;">
                <!--                 <ul>
                    <li onclick='jump_to_image(0)'>[1] 01_noise.png</li>
                    <li onclick='jump_to_image(1)' class="sel">[2] 02_noise.png</li>
                    <li onclick='jump_to_image(2)'>[3] 03_noise.png</li>
                </ul>
 -->
            </div>
            <div style="justify-content: space-around;">
                <span class="matter-button-contained" onclick="projectAddFiles()" title="Add files">Add Files</span>
                <span class="matter-button-contained" onclick="projectDeleteFile()" title="Remove selected file">Remove File</span>
            </div>
        </leftside>
        <!--  add style to remove flex layout -->
        <workspace id="workspace_id" style="display: block">
            <img id="start_image_id" src="mountain.jpg" style="width:100%;height:100%;" alt="Image" />
            <canvas id="canvas_id" tabindex="1" style="display:none;border:1px dashed red;">
            </canvas>
        </workspace>
    </main>
    <footer1 id="footer_id">
        <div style="display:flex;justify-content: space-around;">
            @2020 AI Image Video</div>
        <div id="message_id" class="matter-message" class="matter-h4" style="display:none">message</div>
        <progress class="matter-progress-linear" value="0" max="100" style="display:none">Cleaning ...</progress>
    </footer1>
</body>
<script type="text/javascript">
"use strict";
var project = new ImageProject(defaultProjectName());
var message = new Message("message_id");
var progress = new Progress(0);
var canvas = new Canvas("canvas_id");

function load() {
    message.show("Image Cleaning/Coloring/Zooming/Patching is ready ...", 10);
    progress.startDemo(50); // start 0

    document.getElementById("project_name").value = project.name;

    window.addEventListener("keydown", (e) => {
        // e : KeyboardEvent
        if (e.key == 'Shift' || e.key === 'Escape') {
            fullScreenToggle();
        }
    }, false);

    // Refresh file list -- adding files is async, routine is necessary
    setInterval(() => {
        if (project.fresh()) {
            updateFileList();
            // Need update project name
            document.getElementById("project_name").value = project.name;
        }
    }, 500); // 500 ms
}

function canvasShow(yes) {
    var start_image_e = document.getElementById("start_image_id");
    if (start_image_e) {
        start_image_e.style.display = (yes) ? "none" : "";
    }
    var e = document.getElementById("canvas_id");
    if (e) {
        e.style.display = (yes) ? "" : "none";
    } else {
        console.log("Error: element canvas not exists.");
    }
    e.focus();
}

function canvasResize() {
    // canvas size adjust with background image ...
    var w = document.documentElement.clientWidth;
    var h = document.documentElement.clientHeight;
    var header = document.getElementById("header_id");
    var footer = document.getElementById("footer_id");
    var main = document.getElementById("main_id");
    var leftside = document.getElementById("left_side_id");
    var canvas = document.getElementById("canvas_id");

    h -= header.clientHeight;
    h -= footer.clientHeight;
    w -= leftside.clientWidth;

    canvas.style.height = h + 'px';
    canvas.style.width = w + 'px';
}

function projectSave() {
    project.save();
}

function projectOpen() {
    project.open();
}

function defaultProjectName() {
    const now = new Date();
    var ts = now.getFullYear() + "" + number_padding_with_zeros(now.getMonth() + 1, 2) + "" + number_padding_with_zeros(now.getDate(), 2) +
        "_" + number_padding_with_zeros(now.getHours(), 2) + "" + number_padding_with_zeros(now.getMinutes(), 2);
    var project_name = 'image_' + ts;
    return project_name;
}

function projectChangeName() {
    project.name = document.getElementById("project_name").value;
}

function projectAddFiles() {
    project.addFiles();
    updateFileList();
}

function projectDeleteFile() {
    // delete current file
    project.deleteFile();
    updateFileList();
}

function updateFileList() {
    // Force refresh file list
    document.getElementById("file_name_list_id").innerHTML = project.listHtml();
}

function jump_to_image(index) {
    if (project.go(index)) {
        updateFileList();
        let [current_image, current_index] = project.current();
        canvas.loadBackground(current_image);
        // waiting for image decode finish ...
        sleep(100).then(() => { canvasShow(true); canvas.redraw(); });
        // console.log("Canvas switch to current project item.");
    };
}

function fullScreenToggle() {
    show_or_hiden("header_id");
    show_or_hiden("left_side_id");
    show_or_hiden("footer_id");
}

function show_or_hiden(id) {
    var elem = document.getElementById(id);
    if (elem)
        elem.style.display = (elem.style.display == "none") ? "" : "none";
    else
        console.log("Error: element " + id + " not exists.");
}

function number_padding_with_zeros(num, n) {
    var len = num.toString().length;
    while (len < n) {
        num = "0" + num;
        len++;
    }
    return num;
}
</script>

</html>